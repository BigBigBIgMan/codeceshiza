name: Build Dynamic Library

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Build Dynamic Library
      run: |
        # 列出可用的schemes
        xcodebuild -list -project 654323.xcodeproj
        
        # 构建dylib
        xcodebuild \
          -project 654323.xcodeproj \
          -configuration Release \
          -destination "platform=macOS" \
          build
          
    - name: Find and Upload Artifacts
      run: |
        # 查找生成的dylib文件
        find . -name "*.dylib" -type f
        
        # 创建artifacts目录
        mkdir -p artifacts
        
        # 复制dylib文件到artifacts目录
        find . -name "*.dylib" -type f -exec cp {} artifacts/ \;
        
        # 列出artifacts内容
        ls -la artifacts/
        
    - name: Upload dylib artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dylib-files
        path: artifacts/*.dylib
        if-no-files-found: warn
        
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/*.dylib
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 